

  <style>
  table.table {
      width: 98%;
      max-width: 100%;
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
  }
  table.table ul li {
        list-style: none;
  }
  table.table ul {padding-left: 0px;}
  .search-sec {
      float: right;
      margin: 0 0 20px 0;
      padding: 0;
      box-shadow: none;
      -moz-box-shadow: none;
      -webkit-box-shadow: none;
  }
  .search-sec input[type="text"] {
        height: 36px!important;
      padding: 0 12px;
      line-height: 36px;
      border: 1px solid #d2d2d2;
  }
  .search-sec input[type="submit"] {    width: 100px!important;
      height: 36px!important;
          padding: 0 12px;
      line-height: 36px;
      text-align: center;}
  .search-sec a.clear {     width: auto;
      height: 36px;
      line-height: 36px;
      text-align: center;
      padding: 0 15px}
  .search-sec input[type="text"]:focus {outline: none; border-color: green;}
  .pagination-bottom ul.pagination {margin-bottom: 70px;}
  .content-header table.table thead tr th {min-width: 120px;}
  .search-sec:hover {box-shadow: none!important;}
  .content-header table.table {margin-bottom: 80px;}
  .row {margin-left: 0px; margin-right: 0px;}
  .table-responsive {
      overflow-x: auto;
      min-height: 0.01%;
      width: 100%;
  }


  </style>
  <div class="content-header">
    <div class="login-header">
      <h1><%= t 'guests.guests_list' %></h1>
      <hr>
    </div>

   
      <div class="row">
          <div class="col-md-8"></div>
          <div class="col-md-4">
            <form method="GET" action="">
              <div class="row" style="padding: 10px;">
                <div class="col-md-7">
                  <input class="form-control" type="text" name="keyword" placeholder="<%= t 'guests.search_guest' %>" value="<%= @keyword %>">
                </div>
                
                <div class="col-md-2">
                  <input type="submit" name="submit" value="GO" class="btn btn-success btn-lg" style="width: 70%;">
                  
                </div>
                <div class="col-md-3">
                  <a href="<%= guests_path %>" class="btn btn-info btn-lg"><%= t 'guests.clear_search' %></a>
                </div>
              </div>
            </form>
          </div>
      </div>
  
  </div>

   <!--  <div class="col-md-12 margin-sec">
      <div class="row">
        <div class=" col-md-12 pagination-tab">
          <%= will_paginate @guests %>
        </div>
      </div>
    </div> -->

<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th style='width: 25%'>
          <button type="button" class="btn btn-primary sendEmails"><%= t 'forms.send_emails' %></button>
          <button type="button" class="btn btn-primary" id="sendAll"><%= t 'forms.send_all_emails' %></button>
          <button type="button" class="btn btn-primary sendEmails" id="export"><%= t 'forms.export' %></button>
        </th>
        <th><%= t 'forms.s_no' %></th>
        <th><%= t 'forms.first_name' %></th>
        <th><%= t 'forms.last_name' %></th>
        <th><%= t 'forms.email' %></th>
        <th><%= t 'forms.admin' %></th>
        <th><%= t 'forms.created' %></th>
        <th><%= t 'forms.action' %></th>
      </tr>
    </thead>
    <tbody>
    <% i=1 %>
    <% @guests.each do |guest| %>

      <tr>
        <td><%= check_box('guest', 'check', { class: 'guestCheck', data: { email: guest.email } }) %></td>
        <td> <a href="<%= guests_path(keyword: guest.email) %>"><%= i %></a></td>
        <td> <%= !guest.first_name.nil? ? guest.first_name.capitalize : '' %></td>
        <td> <%= !guest.last_name.nil? ? guest.last_name.capitalize : '' %></td>
        <td> <a href="javascript:void(0)" onclick="sendEmail('<%= guest.email %>')"><%= guest.email %></a></td>
        <td>
          <a href="<%= (guest.chef_info.present?) ? chef_path(guest.chef_info): '#' %>">
            <%= (guest.chef_info.present?) ? guest.chef_info.user.full_name.capitalize : '-' %>
          </a>
        </td>
        <td> <%=  guest.created_at.strftime('%m-%d-%Y') %></td>
        <td>
          <%= link_to t('guests.delete_guest'), destroy_guest_path(guest), method: :delete, data: { confirm: t('guests.are_you_sure_delete_user') } %>
        </td>
      </tr>

      <% i= i+1 %>
    <% end %>

    <% if @guests.blank? %>
      <tr>
        <td colspan="8" style="color:red;text-align:center">
          <%= t 'guests.guest_not_found' %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
  </div>

  <div class="col-md-12 margin-sec pagination">
    <div class="row">
      <div class=" col-md-12 pagination-tab">
        <%= will_paginate @guests %>
      </div>
    </div>
  </div>

</div>

  <!-- Modal -->
  <div id="myModal" class="modal fade" role="dialog" style="margin-top:20px;">
    <div class="modal-dialog" style="margin-top:150px;">
      <%= form_tag('/sendUserEmailContent', method: :post, remote: true, multipart: true, id: "frmSendEmail") do |f| %> 

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title"><%= t 'guests.send_email' %></h4>
        </div>
        <div class="modal-body">
           <div class="form-group">
             <div class="control-label col-md-12"><%= label_tag t 'forms.subject' %></div>
             
             <div class="col-md-12">
               <%= text_field_tag :subject, '',class: "form-control" %>
             </div>
           </div>

           <div class="form-group">
             <div class="control-label col-md-12"><%= label_tag t 'guests.email_content' %></div>
             
             <div class="col-md-12">
               <%= cktext_area :email_content, :content,  {class: "form-control", placeholder: ""}%>
             </div>
           </div>

           
           <%= hidden_field_tag :receivers, '' %>
           <%= hidden_field_tag :send_all, '' %>
           <span id="error_span" style="display:none;color:red;"></span>
           <span id="suc_span" style="display:none;color:green;"><%= t 'guests.email_sent_success' %></span>
           <div class="form-group">
             <div class="control-label col-md-8"><%= label_tag :attachments %></div>
             
             <div class="control-label col-md-8">
               <%= file_field_tag "attachments[]", type: :file, multiple: true, accept: 'image/jpeg,image/gif,image/png,.pdf,.docx,.doc,.txt' %>
             </div>
           </div>
           
        </div>
        <div class="modal-footer">
          <button type="submit"  class="btn btn-primary" ><%= t 'guests.send_email' %></button>
          <button type="button" class="btn btn-default" data-dismiss="modal"><%= t 'forms.close' %></button>
        </div>
        <% end %>
      </div>

    </div>
  </div>

  <script>
  $(document).ready(function() {
    $('#frmSendEmail').on('ajax:success', function(e, data, status, xhr){
      $("input[type=checkbox]").prop('checked',false);
      $('#myModal').modal('hide');
    }).on('ajax:error',function(e, xhr, status, error){
      $("input[type=checkbox]").prop('checked',false);
      $('#myModal').modal('hide');
      console.log(error);
    });

    var timer = setInterval(function () {
      var editor = $('.cke').length
      if (editor != 0) {
        var templateIcon = '<svg id="editorTemplateIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/></svg>'
        var leftIcon = '<svg id="editorLeftIcon" class="ck ck-icon ck-button__icon" viewBox="0 0 20 20"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 4c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75z"></path></svg>'
        var centerIcon = '<svg id="editorCenterIcon" class="ck ck-icon ck-button__icon" viewBox="0 0 20 20"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm2.286 4c0 .414.336.75.75.75h9.928a.75.75 0 1 0 0-1.5H5.036a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h9.928a.75.75 0 1 0 0-1.5H5.036a.75.75 0 0 0-.75.75z"></path></svg>'
        var rightIcon = "<svg id='editorRightIcon' class='ck ck-icon ck-button__icon' viewBox='0 0 20 20'><path d='M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 4c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75z'></path></svg>"
        var blockIcon = '<svg id="editorBlockIcon" class="ck ck-icon ck-button__icon" viewBox="0 0 20 20"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 4c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75z"></path></svg>'
        var collapseIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/></svg>'
        var colorIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-palette" viewBox="0 0 16 16"> <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/> <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8zm-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.369-.417.845-.578 1.272-.618.404-.038.812.026 1.16.104.343.077.702.186 1.025.284l.028.008c.346.105.658.199.953.266.653.148.904.083.991.024C14.717 9.38 15 9.161 15 8a7 7 0 1 0-7 7z"/> </svg>'
        var bgColorIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-palette-fill" viewBox="0 0 16 16"> <path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07zM8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/> </svg>'
        

        $('.cke_button__templates_icon').each(function() {
          $( this ).prepend(templateIcon);
        });
        $('.cke_button__justifyleft').each(function() {
          $( this ).prepend(leftIcon);
        });
        $('.cke_button__justifycenter').each(function() {
          $( this ).prepend(centerIcon);
        });
        $('.cke_button__justifyright').each(function() {
          $( this ).prepend(rightIcon);
        });
        $('.cke_button__justifyblock').each(function() {
          $( this ).prepend(blockIcon);
        });
         $('.cke_button__collapsibleitem').each(function() {
          $( this ).prepend(collapseIcon);
        });
        $('.cke_button__textcolor_icon').each(function() {
          $( this ).prepend(colorIcon);
        });
        $('.cke_button__bgcolor_icon').each(function() {
          $( this ).prepend(bgColorIcon);
        });
        clearInterval(timer);
      }
    }, 500);
  });

  $('#export').on('click', function() {
    var parts = window.location.href.split("?")
    var root = parts[0] + '.xlsx'
    var params = parts.length == 2 ? '?' + parts[1] : ''
    var url = root + params
    console.log(url);
    
    var win = window.open(url, '_blank');
    // if (win) {
    //   win.focus();
    // }
  })

  $('.sendEmails').on('click', function() {
    console.log("Test");
    var emails = $("input[type=checkbox]:checked").map(function () {
        return $(this).data('email');
    }).get();
    if (emails.length > 0) {
        sendEmail(emails);
    } else {
        $('#error_span').text('');
        $('#error_span').text('<%= t 'no_selected_guests' %>');
        $('#error_span').show();
    }
  });

  
  $('#sendAll').on('click', function() {
    var atLeastOneIsChecked = $('input[type=checkbox]:checked').length;
    
    if (atLeastOneIsChecked > 0) {
      $("input[type=checkbox]").prop('checked',false);
    } else {
      $('#send_all').val(1);
      $("input[type=checkbox]").prop('checked',true);
      var  emails = $("input[type=checkbox]:checked").map(function () {
        return $(this).data('email');
      }).get();
      sendEmail(emails);
    }    
  });

  function sendEmail(email) {
    $('#email_content').val('');
    $('#receivers').val('');
    $('#receivers').val(email);
    $('#error_span').text('');
    $('#myModal').modal('show');

  }

  function sendEmailContent() {
    var content = $("#email_content").val();
    var email = $("#sender_email_hdn").val();
    $('#error_span').text('');
     $('#error_span').hide();

     $("#send_btn").attr("disabled", true);
     $("#send_btn").attr("text", "Loading..");
    if(content) {
       $.ajax({
        type: "POST",
        url: "<%= @root_url%>/sendUserEmailContent",
        data: {"content": content, "email": email},
        cache: false,
        success: function(data){
          //console.log(data);
          if(data.status == 'success') {
            $("#email_content").val('');
            $("#suc_span").show();
            setInterval(function() {
                $('#myModal').modal('hide');
                location.reload();
            }, 2000);

          }
           //$("#resultarea").text(data);
        }
      });
    } else {
      $("#send_btn").attr("disabled", false);
      $("#send_btn").attr("text", "Send Email");
      $('#error_span').text('');
      $('#error_span').text('<%= t 'errors.email_content_blank' %>');
      $('#error_span').show();
    }


  }


  </script>


